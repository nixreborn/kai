# Journal Module API Documentation

## Overview

The Journal Module provides a comprehensive journaling system for the Kai mental wellness platform with AI-powered insights and analysis.

## Features

- **Full CRUD operations** for journal entries
- **Rich text support** with title, content, mood tracking, tags, and images
- **AI-powered analysis** using the wellness agent
- **Intelligent journal prompts** generated by Kai agent
- **Wellness insights** from journal history analysis
- **Advanced filtering** by date, mood, tags, and text search
- **Privacy-focused** with user-scoped access

## API Endpoints

### 1. Create Journal Entry

**POST** `/api/journal/entries?user_id={user_id}`

Create a new journal entry with optional mood tracking, tags, and images.

**Request Body:**
```json
{
  "title": "My Day",
  "content": "Today was a peaceful day. I spent time by the water...",
  "mood": 7.5,
  "mood_emoji": "ðŸ˜Š",
  "tags": ["peaceful", "nature", "self-care"],
  "images": []
}
```

**Response:** `201 Created`
```json
{
  "id": "uuid",
  "user_id": "user123",
  "title": "My Day",
  "content": "Today was a peaceful day...",
  "mood": 7.5,
  "mood_emoji": "ðŸ˜Š",
  "tags": ["peaceful", "nature", "self-care"],
  "images": [],
  "ai_insights": null,
  "created_at": "2025-10-20T12:00:00Z",
  "updated_at": "2025-10-20T12:00:00Z"
}
```

### 2. List Journal Entries

**GET** `/api/journal/entries?user_id={user_id}`

List user's journal entries with advanced filtering and pagination.

**Query Parameters:**
- `user_id` (required): User identifier
- `page` (default: 1): Page number
- `page_size` (default: 20, max: 100): Items per page
- `search`: Search in title and content
- `tags`: Filter by tags (can specify multiple)
- `mood_min`: Minimum mood rating (1-10)
- `mood_max`: Maximum mood rating (1-10)
- `start_date`: Filter entries from this date (ISO format)
- `end_date`: Filter entries until this date (ISO format)

**Example:**
```
GET /api/journal/entries?user_id=user123&tags=peaceful&mood_min=6&page=1
```

**Response:** `200 OK`
```json
{
  "entries": [...],
  "total": 50,
  "page": 1,
  "page_size": 20,
  "has_more": true
}
```

### 3. Get Specific Entry

**GET** `/api/journal/entries/{entry_id}?user_id={user_id}`

Retrieve a specific journal entry by ID.

**Response:** `200 OK` - Returns single journal entry object

### 4. Update Journal Entry

**PUT** `/api/journal/entries/{entry_id}?user_id={user_id}`

Update an existing journal entry. All fields are optional.

**Request Body:**
```json
{
  "content": "Updated content...",
  "mood": 8.0,
  "tags": ["updated", "reflection"]
}
```

**Response:** `200 OK` - Returns updated entry

### 5. Delete Journal Entry

**DELETE** `/api/journal/entries/{entry_id}?user_id={user_id}`

Permanently delete a journal entry.

**Response:** `204 No Content`

### 6. Analyze Entry with AI

**POST** `/api/journal/entries/{entry_id}/analyze?user_id={user_id}`

Get AI-powered analysis of a specific journal entry using the wellness agent.

**Response:** `200 OK`
```json
{
  "insights": [
    {
      "category": "emotional",
      "insight": "The entry shows positive emotional regulation and gratitude",
      "severity": "low",
      "recommendations": [
        "Continue practicing gratitude",
        "Maintain connection with nature"
      ],
      "time_period": "This entry"
    }
  ],
  "sentiment": "positive",
  "themes": ["emotional", "social"],
  "suggestions": [
    "Continue practicing gratitude",
    "Maintain connection with nature"
  ]
}
```

The AI analysis:
- Identifies emotional patterns and themes
- Assesses sentiment (positive, neutral, negative, mixed)
- Provides gentle, supportive recommendations
- Stores insights in the entry for future reference

### 7. Get Journal Prompts

**GET** `/api/journal/prompts?user_id={user_id}`

Get AI-generated journal prompts to inspire writing.

**Response:** `200 OK`
```json
{
  "prompts": [
    {
      "prompt": "What emotion has been flowing through you most today?",
      "category": "emotions"
    },
    {
      "prompt": "What are you grateful for in this moment?",
      "category": "gratitude"
    },
    {
      "prompt": "Describe a moment today when you felt at peace.",
      "category": "reflection"
    }
  ]
}
```

Prompts are:
- Generated fresh each time using Kai agent
- Diverse across categories (emotions, gratitude, relationships, growth)
- Supportive and non-judgmental
- Include water/flow metaphors occasionally

### 8. Get Wellness Insights

**GET** `/api/journal/insights?user_id={user_id}&days={days}`

Analyze journal history to identify patterns and provide wellness insights.

**Query Parameters:**
- `user_id` (required): User identifier
- `days` (default: 30, max: 365): Number of days to analyze

**Response:** `200 OK`
```json
{
  "insights": [
    {
      "category": "mood",
      "insight": "Mood patterns show improvement when engaging in outdoor activities",
      "severity": "low",
      "recommendations": [
        "Continue spending time in nature",
        "Consider regular outdoor exercise"
      ],
      "time_period": "last 30 days"
    }
  ],
  "entries_analyzed": 15,
  "time_period": "last 30 days",
  "mood_trend": "improving",
  "writing_streak": 7
}
```

Insights include:
- **Mood trend**: "improving", "stable", or "declining"
- **Writing streak**: Consecutive days of journaling
- **Pattern analysis**: AI-detected behavioral and emotional patterns
- **Personalized recommendations**: Based on identified patterns

## AI Integration

### Wellness Agent

The wellness agent analyzes journal entries for:
- Mood patterns (depression, anxiety, stress)
- Behavioral changes (sleep, appetite, social withdrawal)
- Cognitive patterns (rumination, catastrophizing)
- Emotional regulation
- Social connection

Severity levels:
- **LOW**: Normal variation, general wellness tips
- **MEDIUM**: Notable concerns, coping strategies suggested
- **HIGH**: Significant concerns, professional support recommended

### Kai Agent

Generates personalized journal prompts that:
- Encourage self-reflection
- Cover diverse categories (gratitude, emotions, relationships, growth)
- Use trauma-informed, supportive language
- Incorporate aqua/water metaphors

## Data Models

### Journal Entry
```typescript
{
  id: UUID,
  user_id: string,
  title?: string,
  content: string,
  mood?: number,  // 1-10 scale
  mood_emoji?: string,
  tags: string[],
  images: string[],
  ai_insights?: object,
  created_at: datetime,
  updated_at: datetime
}
```

## Privacy & Security

- All entries are scoped to `user_id` - users can only access their own entries
- Journal content is stored securely in PostgreSQL
- AI analysis is performed on-demand and cached in entries
- Sensitive content detection by guardrail agent (via orchestrator)

## Best Practices

1. **Encourage Daily Journaling**: Use the `/insights` endpoint to show writing streaks
2. **Smart Prompts**: Display prompts when users haven't journaled recently
3. **Mood Tracking**: Make mood input optional but encourage it for better insights
4. **Auto-save**: Implement client-side auto-save for entries in progress
5. **Analysis Timing**: Run AI analysis after entry creation or on-demand
6. **Privacy First**: Clearly communicate that entries are private and secure

## Example Workflow

1. User opens journal interface
2. Frontend calls `/api/journal/prompts` to show inspiring prompts
3. User writes entry and submits to `/api/journal/entries`
4. Frontend optionally calls `/api/journal/entries/{id}/analyze` for immediate insights
5. Dashboard displays recent entries from `/api/journal/entries?page=1&page_size=5`
6. Weekly insights page calls `/api/journal/insights?days=7` for patterns

## Error Responses

- `404 Not Found`: Entry doesn't exist or doesn't belong to user
- `422 Validation Error`: Invalid request data
- `500 Internal Server Error`: Server or AI processing error

All errors return:
```json
{
  "detail": "Error message"
}
```
